<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>2025 è€ƒè¯•å­£æ—¥å†ç”Ÿæˆå™¨</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel for JSX in-browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>

  <body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useMemo } = React;

      // --- 1. è€ƒè¯•æ•°æ®æº ---
      const EXAM_DATA = [
        // --- IGCSE ç¤ºä¾‹æ•°æ® ---
        { id: 'ig_math_p2', grade: 'IGCSE', board: 'CIE', subject: 'Maths (0580)', paper: 'Paper 2 (Extended)', date: '2025-05-02', time: '09:00', duration: 90 },
        { id: 'ig_math_p4', grade: 'IGCSE', board: 'CIE', subject: 'Maths (0580)', paper: 'Paper 4 (Extended)', date: '2025-05-05', time: '13:00', duration: 150 },
        { id: 'ig_phy_p4', grade: 'IGCSE', board: 'CIE', subject: 'Physics (0625)', paper: 'Theory', date: '2025-05-12', time: '09:00', duration: 75 },

        // --- AS Level ç¤ºä¾‹æ•°æ® ---
        { id: 'as_econ_p1', grade: 'AS', board: 'CIE', subject: 'Economics (9708)', paper: 'Multiple Choice', date: '2025-06-10', time: '13:00', duration: 60 },
        { id: 'as_econ_p2', grade: 'AS', board: 'CIE', subject: 'Economics (9708)', paper: 'Data Response', date: '2025-05-12', time: '09:00', duration: 90 },
        { id: 'as_math_pure', grade: 'AS', board: 'Edexcel', subject: 'Maths (Pure)', paper: 'Pure 1', date: '2025-05-15', time: '09:00', duration: 120 },

        // --- A Level ç¤ºä¾‹æ•°æ® ---
        { id: 'al_psy_p3', grade: 'ALevel', board: 'CIE', subject: 'Psychology (9990)', paper: 'Specialist Options', date: '2025-05-20', time: '09:00', duration: 90 },
        { id: 'al_chem_p4', grade: 'ALevel', board: 'CIE', subject: 'Chemistry (9701)', paper: 'Structured Questions', date: '2025-05-22', time: '13:00', duration: 120 },
        { id: 'al_math_stat', grade: 'ALevel', board: 'Edexcel', subject: 'Maths (Stats)', paper: 'Statistics 2', date: '2025-06-01', time: '09:00', duration: 90 },
      ];

      // å®šä¹‰å¹´çº§æ˜¾ç¤ºçš„é¡ºåºå’Œæ ‡é¢˜
      // HTML å•æ–‡ä»¶ç‰ˆæœ¬ä¸ä½¿ç”¨ lucide-reactï¼Œæ”¹ç”¨ emoji / æ–‡æœ¬å›¾æ ‡
      const GRADE_SECTIONS = [
        { key: 'IGCSE', title: 'IGCSE', icon: 'ğŸ“˜' },
        { key: 'AS', title: 'AS Level', icon: 'ğŸ§©' },
        { key: 'ALevel', title: 'A Level', icon: 'ğŸ“' },
      ];

      function App() {
        const [selectedSubjects, setSelectedSubjects] = useState([]);
        const [generated, setGenerated] = useState(false);

        // æå–æ¯ä¸ªå¹´çº§çš„å”¯ä¸€ç§‘ç›®
        const subjectsByGrade = useMemo(() => {
          const grouped = {};
          GRADE_SECTIONS.forEach(section => {
            const examsInGrade = EXAM_DATA.filter(e => e.grade === section.key);
            const unique = [];
            const seen = new Set();

            examsInGrade.forEach(exam => {
              const uniqueKey = `${exam.subject}|${exam.board}`;
              if (!seen.has(uniqueKey)) {
                seen.add(uniqueKey);
                unique.push({
                  name: exam.subject,
                  board: exam.board,
                  fullKey: uniqueKey
                });
              }
            });
            grouped[section.key] = unique;
          });
          return grouped;
        }, []);

        const toggleSubject = (subjectKey) => {
          setSelectedSubjects(prev =>
            prev.includes(subjectKey)
              ? prev.filter(s => s !== subjectKey)
              : [...prev, subjectKey]
          );
          setGenerated(false);
        };

        const myExams = useMemo(() => {
          return EXAM_DATA
            .filter(exam => selectedSubjects.includes(`${exam.subject}|${exam.board}`))
            .sort((a, b) => new Date(`${a.date}T${a.time}`) - new Date(`${b.date}T${b.time}`));
        }, [selectedSubjects]);

        // --------- å…³é”®ä¿®å¤ï¼šICS æ—¶é—´ä¸è¦ç”¨ toISOString() ---------
        // å¦åˆ™ä¼šå˜æˆ UTC + Zï¼Œå¯¼å…¥åå¯èƒ½å‡ºç°æ—¶åŒºé”™ä½ã€‚
        // è¿™é‡Œç”¨â€œæœ¬åœ°æ—¶é—´å­—ç¬¦ä¸²â€ï¼Œå¹¶åŠ  TZIDï¼ˆå¯æ”¹ï¼‰ã€‚
        const TZID = "Asia/Shanghai"; 
        // å¦‚æœä½ è¦æ”¹æˆåˆ«çš„æ—¶åŒºï¼Œä¾‹å¦‚æ´›æ‰çŸ¶ï¼š
        // const TZID = "America/Los_Angeles";

        const pad = (n) => String(n).padStart(2, "0");

        const formatLocalICSDate = (dateObj) => {
          const y = dateObj.getFullYear();
          const m = pad(dateObj.getMonth() + 1);
          const d = pad(dateObj.getDate());
          const hh = pad(dateObj.getHours());
          const mm = pad(dateObj.getMinutes());
          const ss = pad(dateObj.getSeconds());
          // ä¸å¸¦ Zï¼Œè¡¨ç¤ºâ€œæœ¬åœ°/æŒ‡å®šæ—¶åŒºçš„æµ®åŠ¨æ—¶é—´â€
          return `${y}${m}${d}T${hh}${mm}${ss}`;
        };

        const generateICSFile = () => {
          if (myExams.length === 0) return;

          let icsContent =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//MySchool//ExamSchedule//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
`;

          myExams.forEach(exam => {
            const startDateTime = new Date(`${exam.date}T${exam.time}`);
            const endDateTime = new Date(startDateTime.getTime() + exam.duration * 60000);

            const dtStart = formatLocalICSDate(startDateTime);
            const dtEnd = formatLocalICSDate(endDateTime);
            const nowStamp = formatLocalICSDate(new Date());

            const description = [
              `ç§‘ç›®: ${exam.subject}`,
              `è¯•å·: ${exam.paper}`,
              `æ—¶é•¿: ${exam.duration}åˆ†é’Ÿ`,
              `è€ƒè¯•å±€: ${exam.board}`,
              `è€ƒè¯•æˆ¿é—´: ${exam.room || 'å¾…å®š (è¯·æŸ¥çœ‹å­¦æ ¡å…¬å‘Š)'}`,
              `è¯·æå‰15åˆ†é’Ÿåˆ°è¾¾è€ƒåœºå‡†å¤‡ã€‚`
            ].join('\\n');

            // UID ç”¨ exam.id + å½“å‰æ—¶é—´ï¼Œé¿å…é‡å¤
            const uid = `${exam.id}-${Date.now()}@myschool.com`;

            icsContent +=
`BEGIN:VEVENT
UID:${uid}
DTSTAMP:${nowStamp}
DTSTART;TZID=${TZID}:${dtStart}
DTEND;TZID=${TZID}:${dtEnd}
SUMMARY:ğŸ“ [${exam.board}] ${exam.subject} - ${exam.paper}
DESCRIPTION:${description}
LOCATION:${exam.room || 'School Exam Hall'}
STATUS:CONFIRMED
BEGIN:VALARM
TRIGGER:-P1D
ACTION:DISPLAY
DESCRIPTION:Reminder: ${exam.subject} Exam is tomorrow!
END:VALARM
BEGIN:VALARM
TRIGGER:-PT2H
ACTION:DISPLAY
DESCRIPTION:Reminder: ${exam.subject} Exam in 2 hours. Go to prep room soon!
END:VALARM
END:VEVENT
`;
          });

          icsContent += `END:VCALENDAR`;

          const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.setAttribute('download', 'My_Exam_Schedule_2025.ics');
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(url);
          setGenerated(true);
        };

        return (
          <div className="min-h-screen py-8 px-4 font-sans text-gray-800">
            <div className="max-w-4xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden border border-gray-200">

              {/* Header */}
              <div className="bg-indigo-600 p-8 text-white">
                <h1 className="text-3xl font-bold flex items-center gap-3">
                  <span className="text-3xl">ğŸ—“ï¸</span>
                  2025 è€ƒè¯•å­£æ—¥å†ç”Ÿæˆå™¨
                </h1>
                <p className="mt-3 text-indigo-100 max-w-2xl">
                  ä¸“ä¸º IG, AS, A-Level åŒå­¦è®¾è®¡ã€‚å‹¾é€‰ä½ çš„ç§‘ç›®ï¼Œè‡ªåŠ¨ç”ŸæˆåŒ…å«
                  <b>è€ƒå‰æé†’</b>ã€<b>è€ƒè¯•å±€</b>åŠ<b>è€ƒåœºä¿¡æ¯</b>çš„ä¸“å±æ—¥å†ã€‚
                </p>
              </div>

              <div className="p-8">
                {/* å¹´çº§/ç§‘ç›®é€‰æ‹©åŒºåŸŸ */}
                <div className="space-y-10">
                  {GRADE_SECTIONS.map((section) => {
                    const subjects = subjectsByGrade[section.key];
                    if (!subjects || subjects.length === 0) return null;

                    return (
                      <div key={section.key} className="animate-in fade-in duration-500">
                        <h2 className="text-xl font-bold flex items-center gap-2 mb-4 text-gray-800 border-b border-gray-100 pb-2">
                          <span className="p-2 bg-indigo-50 text-indigo-600 rounded-lg">
                            {section.icon}
                          </span>
                          {section.title}
                        </h2>

                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                          {subjects.map((sub) => {
                            const isSelected = selectedSubjects.includes(sub.fullKey);

                            return (
                              <button
                                key={sub.fullKey}
                                onClick={() => toggleSubject(sub.fullKey)}
                                className={`
                                  relative flex flex-col items-start p-3 rounded-xl border-2 transition-all duration-200 text-left
                                  ${isSelected
                                    ? 'border-indigo-500 bg-indigo-50/50 shadow-sm'
                                    : 'border-gray-100 hover:border-indigo-200 hover:bg-gray-50'
                                  }
                                `}
                              >
                                <div className="flex justify-between w-full items-start mb-1">
                                  <span className={`text-xs font-bold px-2 py-0.5 rounded text-white
                                    ${sub.board === 'CIE' ? 'bg-orange-500' : 'bg-blue-500'}
                                  `}>
                                    {sub.board}
                                  </span>
                                  {isSelected && <span className="text-indigo-600 text-lg">âœ…</span>}
                                </div>
                                <span className={`font-semibold ${isSelected ? 'text-indigo-900' : 'text-gray-700'}`}>
                                  {sub.name}
                                </span>
                              </button>
                            );
                          })}
                        </div>
                      </div>
                    );
                  })}
                </div>

                {/* é¢„è§ˆå’Œä¸‹è½½åŒºåŸŸ */}
                <div className="mt-12 pt-8 border-t border-gray-100">
                  <div className="flex flex-col sm:flex-row items-center justify-between mb-6 gap-4">
                    <div className="flex items-center gap-3">
                      <div className="bg-indigo-100 p-2 rounded-full">
                        <span className="text-indigo-600 text-xl">â°</span>
                      </div>
                      <div>
                        <h2 className="text-lg font-bold text-gray-900">
                          å·²é€‰è€ƒè¯•é¢„è§ˆ
                        </h2>
                        <p className="text-sm text-gray-500">
                          å…± {myExams.length} åœºè€ƒè¯• â€¢ å·²é…ç½® 2 ä¸ªè‡ªåŠ¨æé†’
                        </p>
                      </div>
                    </div>

                    <button
                      onClick={generateICSFile}
                      disabled={myExams.length === 0}
                      className={`
                        flex items-center gap-2 px-6 py-3 rounded-lg font-bold shadow-md transition-all
                        ${myExams.length > 0
                          ? 'bg-indigo-600 hover:bg-indigo-700 text-white hover:scale-105 active:scale-95'
                          : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                        }
                      `}
                    >
                      <span>â¬‡ï¸</span>
                      ç”Ÿæˆæ—¥å† (.ics)
                    </button>
                  </div>

                  {/* åˆ—è¡¨é¢„è§ˆ */}
                  {myExams.length > 0 ? (
                    <div className="bg-white rounded-xl border border-gray-200 shadow-inner overflow-hidden max-h-[500px] overflow-y-auto">
                      <table className="w-full text-left text-sm">
                        <thead className="bg-gray-50 text-gray-500 font-medium border-b border-gray-200 sticky top-0">
                          <tr>
                            <th className="p-4">æ—¥æœŸ</th>
                            <th className="p-4">æ—¶é—´</th>
                            <th className="p-4">ç§‘ç›® / è¯•å·</th>
                            <th className="p-4 hidden sm:table-cell">è€ƒè¯•å±€</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100">
                          {myExams.map((exam) => (
                            <tr key={exam.id} className="hover:bg-indigo-50/30 transition-colors">
                              <td className="p-4 whitespace-nowrap font-medium text-gray-900">
                                {exam.date}
                              </td>
                              <td className="p-4 whitespace-nowrap text-gray-600">
                                {exam.time} <span className="text-xs text-gray-400">({exam.duration}m)</span>
                              </td>
                              <td className="p-4">
                                <div className="font-bold text-indigo-900">{exam.subject}</div>
                                <div className="text-gray-500">{exam.paper}</div>
                                <div className="text-xs text-orange-600 mt-1 font-medium">è¯·æå‰15åˆ†é’Ÿåˆ°è¾¾</div>
                              </td>
                              <td className="p-4 hidden sm:table-cell">
                                <span className={`text-xs font-bold px-2 py-1 rounded 
                                  ${exam.board === 'CIE' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}
                                `}>
                                  {exam.board}
                                </span>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  ) : (
                    <div className="text-center py-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                      <p className="text-gray-400">è¯·åœ¨ä¸Šæ–¹é€‰æ‹©ç§‘ç›®ä»¥é¢„è§ˆè¯¦æƒ…</p>
                    </div>
                  )}

                  {/* ä¸‹è½½æˆåŠŸæç¤º */}
                  {generated && (
                    <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg flex items-start gap-3 animate-in slide-in-from-top-2">
                      <span className="text-green-600 text-lg">ğŸŸ¢</span>
                      <div className="text-sm text-green-800">
                        <p className="font-bold">æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼</p>
                        <p>å¯¼å…¥åï¼Œä½ ä¼šçœ‹åˆ°æ¯åœºè€ƒè¯•éƒ½æœ‰ä¸¤ä¸ªæé†’ï¼šå¼€è€ƒå‰ 1 å¤©ï¼Œä»¥åŠå¼€è€ƒå‰ 2 å°æ—¶ã€‚</p>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>

            <div className="text-center mt-8 text-gray-400 text-xs">
              <p>Supported Exam Boards: CIE & Edexcel â€¢ Exam Season 2025</p>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>