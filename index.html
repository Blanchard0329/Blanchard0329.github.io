<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 è€ƒè¯•å­£æ—¥å†ç”Ÿæˆå™¨ / 2025 Exam Calendar Generator</title>
    <!-- å¼•å…¥ Tailwind CSS è¿›è¡Œæ ·å¼è®¾è®¡ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Lucide å›¾æ ‡åº“ -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- å¼•å…¥ html2canvas ç”¨äºç”Ÿæˆå›¾ç‰‡ -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7cc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a1a1aa; }
        .fade-in-init { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 min-h-screen py-8 px-4">

    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden border border-gray-200 relative">
        
        <!-- å¤´éƒ¨åŒºåŸŸ -->
        <div class="bg-indigo-600 p-8 text-white relative">
            <!-- è¯­è¨€åˆ‡æ¢æŒ‰é’® -->
            <button onclick="toggleLanguage()" class="absolute top-6 right-6 flex items-center gap-2 bg-indigo-700 hover:bg-indigo-800 text-xs font-bold py-1.5 px-3 rounded-full transition-colors border border-indigo-500">
                <i data-lucide="languages" class="w-3 h-3"></i>
                <span id="lang-btn-text">English</span>
            </button>

            <h1 class="text-3xl font-bold flex items-center gap-3">
                <i data-lucide="calendar" class="w-8 h-8"></i>
                <span id="header-title">2025 è€ƒè¯•å­£æ—¥å†ç”Ÿæˆå™¨</span>
            </h1>
            
            <p id="header-subtitle" class="mt-3 text-indigo-100 max-w-2xl leading-relaxed">
                ä¸“ä¸º IG, AS, A-Level åŒå­¦è®¾è®¡ã€‚å‹¾é€‰ä½ çš„ç§‘ç›®ï¼Œè‡ªåŠ¨ç”ŸæˆåŒ…å«<b>è€ƒå‰æé†’</b>ã€<b>è€ƒè¯•å±€</b>åŠ<b>è€ƒåœºä¿¡æ¯</b>çš„ä¸“å±æ—¥å†ã€‚
            </p>

            <!-- ä¼˜åŒ–åçš„ç¬”è®°åˆ†äº«é“¾æ¥ -->
            <div class="mt-4 p-3 bg-indigo-700/50 rounded-lg border border-indigo-500/50 flex flex-col sm:flex-row sm:items-center gap-2 text-sm text-indigo-50">
                <span class="flex items-center gap-2">
                    <i data-lucide="book-open-check" class="w-4 h-4 text-yellow-300"></i>
                    <span id="note-text-pre">å¤‡è€ƒå¤ä¹ éœ€è¦åŠ©åŠ›ï¼Ÿæ¬¢è¿è®¿é—®æˆ‘çš„</span>
                </span>
                <a href="https://blanchard0329.notion.site/" target="_blank" class="font-bold text-white underline decoration-yellow-400 decoration-2 underline-offset-2 hover:text-yellow-200 transition-colors flex items-center gap-1">
                    <span id="note-link-text">ä¸ªäººç¬”è®°å…±äº«ç«™</span>
                    <i data-lucide="external-link" class="w-3 h-3"></i>
                </a>
            </div>

            <!-- è”ç³»æ–¹å¼ -->
            <div class="mt-2 text-xs text-indigo-200 flex items-center gap-2">
                <i data-lucide="mail" class="w-3 h-3"></i>
                <span id="contact-text">é‡åˆ°é—®é¢˜ï¼Ÿè”ç³»æˆ‘ï¼š</span>
                <a href="mailto:Blanchard.0329@gmail.com" class="hover:text-white underline">Blanchard.0329@gmail.com</a>
            </div>
        </div>

        <div class="p-8">
            <!-- è€ƒè¯•ç§‘ç›®é€‰æ‹©åŒºåŸŸ -->
            <div id="sections-container" class="space-y-10">
                <!-- å†…å®¹åŠ è½½ä¸­... -->
            </div>

            <!-- åº•éƒ¨é¢„è§ˆå’Œæ“ä½œåŒºåŸŸ -->
            <div class="mt-12 pt-8 border-t border-gray-100">
                <div class="flex flex-col xl:flex-row items-end justify-between mb-6 gap-6">
                    <!-- å·¦ä¾§çŠ¶æ€ -->
                    <div class="flex items-center gap-3 w-full xl:w-auto">
                        <div id="bell-icon-container" class="p-2 rounded-full transition-colors bg-indigo-100 shrink-0">
                            <i data-lucide="bell" class="w-6 h-6 text-indigo-600"></i>
                        </div>
                        <div>
                            <h2 id="preview-title" class="text-lg font-bold text-gray-900">å·²é€‰è€ƒè¯•é¢„è§ˆ</h2>
                            <p id="preview-status-text" class="text-sm text-gray-500">
                                è¯·é€‰æ‹©ç§‘ç›®...
                            </p>
                        </div>
                    </div>
                    
                    <!-- å³ä¾§æ“ä½œ -->
                    <div class="flex flex-col sm:flex-row items-end sm:items-center gap-3 w-full xl:w-auto justify-end">
                        <label class="flex items-center gap-2 cursor-pointer text-sm font-medium text-gray-600 hover:text-indigo-700 transition-colors select-none bg-white px-2 py-1 rounded border border-transparent hover:border-gray-100">
                            <input type="checkbox" id="alert-toggle" checked class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 accent-indigo-600">
                            <span id="alert-label">æ·»åŠ è€ƒå‰æé†’</span>
                        </label>

                        <!-- æŒ‰é’®ç»„ -->
                        <div class="flex gap-2">
                            <button id="generate-img-btn" disabled onclick="generateImage()" class="flex items-center gap-2 px-4 py-3 rounded-lg font-bold shadow-md transition-all bg-gray-200 text-gray-400 cursor-not-allowed text-sm">
                                <i data-lucide="image" class="w-4 h-4"></i>
                                <span id="btn-img-text">ç”Ÿæˆå›¾ç‰‡ (.png)</span>
                            </button>

                            <button id="generate-btn" disabled class="flex items-center gap-2 px-4 py-3 rounded-lg font-bold shadow-md transition-all bg-gray-200 text-gray-400 cursor-not-allowed text-sm">
                                <i data-lucide="download" class="w-4 h-4"></i>
                                <span id="btn-ics-text">ç”Ÿæˆæ—¥å† (.ics)</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- åˆ—è¡¨é¢„è§ˆå®¹å™¨ -->
                <div id="preview-container" class="bg-white rounded-xl border border-gray-200 shadow-inner overflow-hidden max-h-[500px] overflow-y-auto hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-gray-500 font-medium border-b border-gray-200 sticky top-0 bg-gray-50 z-10">
                            <tr>
                                <th id="th-date" class="p-4">æ—¥æœŸ</th>
                                <th id="th-time" class="p-4">æ—¶é—´</th>
                                <th id="th-subject" class="p-4">ç§‘ç›® / è¯•å·</th>
                                <th id="th-board" class="p-4 hidden sm:table-cell">è€ƒè¯•å±€</th>
                            </tr>
                        </thead>
                        <tbody id="preview-table-body" class="divide-y divide-gray-100">
                            <!-- è¡Œæ•°æ®å°†ç”± JS æ’å…¥ -->
                        </tbody>
                    </table>
                </div>

                <!-- ç©ºçŠ¶æ€æç¤º -->
                <div id="empty-state" class="text-center py-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                    <p id="empty-text" class="text-gray-400">è¯·åœ¨ä¸Šæ–¹é€‰æ‹©ç§‘ç›®ä»¥é¢„è§ˆè¯¦æƒ…</p>
                </div>

                <!-- æˆåŠŸæç¤º -->
                <div id="success-message" class="hidden mt-4 p-4 bg-green-50 border border-green-200 rounded-lg flex items-start gap-3 fade-in-init">
                    <i data-lucide="check-circle-2" class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"></i>
                    <div class="text-sm text-green-800">
                        <p id="success-title" class="font-bold">æ“ä½œæˆåŠŸï¼</p>
                        <p id="success-desc">æ–‡ä»¶å·²ä¸‹è½½ã€‚</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="text-center mt-8 text-gray-400 text-xs">
        <p>Supported Exam Boards: CIE & Edexcel â€¢ Exam Season 2025 â€¢ Contact: Blanchard.0329@gmail.com</p>
    </div>

    <!-- éšè—çš„å›¾ç‰‡ç”Ÿæˆå®¹å™¨ (ç”¨äº html2canvas æˆªå›¾) -->
    <div id="image-export-container" class="absolute top-0 left-0 -z-50 w-[800px] bg-white p-8" style="transform: translateX(-9999px)">
        <div class="border-2 border-indigo-600 rounded-xl overflow-hidden">
            <div class="bg-indigo-600 p-6 text-white flex justify-between items-center">
                <div>
                    <h2 class="text-3xl font-bold mb-1" id="img-header-title">2025 Exam Schedule</h2>
                    <p class="text-indigo-200 text-sm" id="img-header-subtitle">Generated by My School Exam Calendar</p>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold" id="img-total-count">0 Exams</div>
                    <!-- é‚®ç®±å·²ç§»é™¤ -->
                </div>
            </div>
            <div class="p-6 bg-white">
                <table class="w-full text-left">
                    <thead class="border-b-2 border-indigo-100 text-indigo-900">
                        <tr>
                            <th class="pb-3 pl-2 w-1/4" id="img-th-time">Time / Date</th>
                            <th class="pb-3 w-2/5" id="img-th-subject">Subject</th>
                            <th class="pb-3 w-1/3" id="img-th-details">Details</th>
                        </tr>
                    </thead>
                    <tbody id="image-table-body" class="divide-y divide-gray-100 text-sm">
                        <!-- Content injected here -->
                    </tbody>
                </table>
            </div>
            <div class="bg-gray-50 p-4 text-center text-gray-400 text-xs border-t border-gray-100">
                Study Hard & Good Luck! â€¢ https://blanchard0329.notion.site/
            </div>
        </div>
    </div>

    <!-- é€»è¾‘è„šæœ¬ -->
    <script>
        // --- 1. å¤šè¯­è¨€é…ç½® ---
        const i18n = {
            zh: {
                btnLang: "Switch to English",
                title: "2025 è€ƒè¯•å­£æ—¥å†ç”Ÿæˆå™¨",
                subtitle: "ä¸“ä¸º IG, AS, A-Level åŒå­¦è®¾è®¡ã€‚å‹¾é€‰ä½ çš„ç§‘ç›®ï¼Œè‡ªåŠ¨ç”ŸæˆåŒ…å«<b>è€ƒå‰æé†’</b>ã€<b>è€ƒè¯•å±€</b>åŠ<b>è€ƒåœºä¿¡æ¯</b>çš„ä¸“å±æ—¥å†ã€‚",
                noteTextPre: "å¤‡è€ƒå¤ä¹ éœ€è¦åŠ©åŠ›ï¼Ÿæ¬¢è¿è®¿é—®æˆ‘çš„",
                noteLinkText: "ä¸ªäººç¬”è®°å…±äº«ç«™",
                contactText: "é‡åˆ°é—®é¢˜ï¼Ÿè”ç³»æˆ‘ï¼š",
                previewTitle: "å·²é€‰è€ƒè¯•é¢„è§ˆ",
                emptyText: "è¯·åœ¨ä¸Šæ–¹é€‰æ‹©ç§‘ç›®ä»¥é¢„è§ˆè¯¦æƒ…",
                alertLabel: "æ·»åŠ è€ƒå‰æé†’",
                btnImg: "ç”Ÿæˆå›¾ç‰‡ (.png)",
                btnIcs: "ç”Ÿæˆæ—¥å† (.ics)",
                thDate: "æ—¥æœŸ",
                thTime: "æ—¶é—´",
                thSubject: "ç§‘ç›® / è¯•å·",
                thBoard: "è€ƒè¯•å±€",
                statusSelected: (count, alerts) => `å…± ${count} åœºè€ƒè¯• â€¢ ${alerts ? 'å·²å¼€å¯è‡ªåŠ¨æé†’ (1å¤©å‰ & 2å°æ—¶å‰)' : 'è‡ªåŠ¨æé†’å·²å…³é—­'}`,
                statusEmpty: "è¯·é€‰æ‹©ç§‘ç›®...",
                successTitle: "æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼",
                successDescIcs: (alerts) => alerts ? "è¯·åœ¨æ‰‹æœºæˆ–ç”µè„‘ä¸Šæ‰“å¼€è¯¥æ–‡ä»¶ã€‚å¯¼å…¥ååŒ…å«ï¼šå¼€è€ƒå‰ 1 å¤©åŠå¼€è€ƒå‰ 2 å°æ—¶çš„è‡ªåŠ¨æé†’ã€‚" : "æ–‡ä»¶å·²ç”Ÿæˆã€‚ç›´æ¥å¯¼å…¥å³å¯æŸ¥çœ‹æ—¶é—´è¡¨ã€‚",
                successDescImg: "å›¾ç‰‡å·²ä¿å­˜åˆ°ä½ çš„è®¾å¤‡ã€‚",
                arriveEarly: "è¯·æå‰15åˆ†é’Ÿåˆ°è¾¾",
                room: "è€ƒåœº",
                roomPending: "å¾…å®š",
                reminder1d: "è€ƒè¯•å°±åœ¨æ˜å¤©ï¼",
                reminder2h: "è€ƒè¯•è¿˜æœ‰2å°æ—¶ï¼Œå¿«å»å‡†å¤‡ï¼",
                gradeIG: "IGCSE",
                gradeAS: "AS Level",
                gradeAL: "A Level",
                imgHeader: "2025 è€ƒè¯•æ—¶åˆ»è¡¨",
                imgSubHeader: "ç¥è€ƒè¯•é¡ºåˆ©ï¼",
                imgThTime: "æ—¶é—´ / æ—¥æœŸ",
                imgThSubject: "ç§‘ç›®",
                imgThDetails: "è€ƒåœº / å¤‡æ³¨"
            },
            en: {
                btnLang: "åˆ‡æ¢ä¸ºä¸­æ–‡",
                title: "2025 Exam Calendar Generator",
                subtitle: "Designed for IG, AS, A-Level students. Select your subjects to generate a calendar with <b>reminders</b>, <b>exam boards</b>, and <b>venue info</b>.",
                noteTextPre: "Need revision materials? Visit my",
                noteLinkText: "Note Sharing Space",
                contactText: "Questions? Contact me:",
                previewTitle: "Exam Preview",
                emptyText: "Select subjects above to preview",
                alertLabel: "Add Reminders",
                btnImg: "Save Image (.png)",
                btnIcs: "Download (.ics)",
                thDate: "Date",
                thTime: "Time",
                thSubject: "Subject / Paper",
                thBoard: "Board",
                statusSelected: (count, alerts) => `${count} Exams Selected â€¢ ${alerts ? 'Alerts On (1 day & 2h before)' : 'Alerts Off'}`,
                statusEmpty: "Select subjects...",
                successTitle: "Download Successful!",
                successDescIcs: (alerts) => alerts ? "Import this file to your calendar app. Includes reminders 1 day & 2 hours before each exam." : "File generated. Import to view your schedule.",
                successDescImg: "Image saved to your device.",
                arriveEarly: "Arrive 15 mins early",
                room: "Room",
                roomPending: "TBA",
                reminder1d: "Exam is tomorrow!",
                reminder2h: "Exam in 2 hours. Go to prep room!",
                gradeIG: "IGCSE",
                gradeAS: "AS Level",
                gradeAL: "A Level",
                imgHeader: "2025 Exam Schedule",
                imgSubHeader: "Good Luck!",
                imgThTime: "Time / Date",
                imgThSubject: "Subject",
                imgThDetails: "Venue / Notes"
            }
        };

        // --- 2. æ•°æ®æºé…ç½® ---
        const EXAM_DATA = [
            // --- IGCSE ---
            { id: 'ig_math_p2', grade: 'IGCSE', board: 'CIE', subject: 'Maths (0580)', paper: 'Paper 2 (Extended)', date: '2025-05-02', time: '09:00', duration: 90 },
            { id: 'ig_math_p4', grade: 'IGCSE', board: 'CIE', subject: 'Maths (0580)', paper: 'Paper 4 (Extended)', date: '2025-05-05', time: '13:00', duration: 150 },
            { id: 'ig_phy_p4', grade: 'IGCSE', board: 'CIE', subject: 'Physics (0625)', paper: 'Theory', date: '2025-05-12', time: '09:00', duration: 75 },
            
            // --- AS Level ---
            { id: 'as_econ_p1', grade: 'AS', board: 'CIE', subject: 'Economics (9708)', paper: 'Multiple Choice', date: '2025-06-10', time: '13:00', duration: 60 },
            { id: 'as_econ_p2', grade: 'AS', board: 'CIE', subject: 'Economics (9708)', paper: 'Data Response', date: '2025-05-12', time: '09:00', duration: 90 },
            { id: 'as_math_pure', grade: 'AS', board: 'Edexcel', subject: 'Maths (Pure)', paper: 'Pure 1', date: '2025-05-15', time: '09:00', duration: 120 },
            
            // --- A Level ---
            { id: 'al_psy_p3', grade: 'ALevel', board: 'CIE', subject: 'Psychology (9990)', paper: 'Specialist Options', date: '2025-05-20', time: '09:00', duration: 90 },
            { id: 'al_chem_p4', grade: 'ALevel', board: 'CIE', subject: 'Chemistry (9701)', paper: 'Structured Questions', date: '2025-05-22', time: '13:00', duration: 120 },
            { id: 'al_math_stat', grade: 'ALevel', board: 'Edexcel', subject: 'Maths (Stats)', paper: 'Statistics 2', date: '2025-06-01', time: '09:00', duration: 90 },
        ];

        const GRADE_SECTIONS = [
            { key: 'IGCSE', title: 'IGCSE', icon: 'book-open' },
            { key: 'AS', title: 'AS Level', icon: 'layers' },
            { key: 'ALevel', title: 'A Level', icon: 'graduation-cap' },
        ];

        // --- 3. çŠ¶æ€ç®¡ç† ---
        let state = {
            selectedSubjects: new Set(),
            includeAlerts: true,
            lang: 'zh' // é»˜è®¤ä¸ºä¸­æ–‡
        };

        // --- 4. è¾…åŠ©é€»è¾‘ ---

        // åˆ‡æ¢è¯­è¨€
        function toggleLanguage() {
            state.lang = state.lang === 'zh' ? 'en' : 'zh';
            updateUIText();
            renderSections(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°å¹´çº§æ ‡é¢˜ï¼ˆå¦‚æœæœ‰éœ€è¦ï¼‰
            updatePreview();  // æ›´æ–°é¢„è§ˆè¡¨å¤´çš„è¯­è¨€
        }

        // æ›´æ–°ç•Œé¢æ‰€æœ‰é™æ€æ–‡æœ¬
        function updateUIText() {
            const t = i18n[state.lang];
            document.getElementById('lang-btn-text').innerText = t.btnLang;
            document.getElementById('header-title').innerText = t.title;
            document.getElementById('header-subtitle').innerHTML = t.subtitle;
            document.getElementById('note-text-pre').innerText = t.noteTextPre;
            document.getElementById('note-link-text').innerText = t.noteLinkText;
            document.getElementById('contact-text').innerText = t.contactText;
            document.getElementById('preview-title').innerText = t.previewTitle;
            document.getElementById('empty-text').innerText = t.emptyText;
            document.getElementById('alert-label').innerText = t.alertLabel;
            document.getElementById('btn-img-text').innerText = t.btnImg;
            document.getElementById('btn-ics-text').innerText = t.btnIcs;
            document.getElementById('th-date').innerText = t.thDate;
            document.getElementById('th-time').innerText = t.thTime;
            document.getElementById('th-subject').innerText = t.thSubject;
            document.getElementById('th-board').innerText = t.thBoard;
            
            // æ›´æ–°å›¾ç‰‡ç”Ÿæˆæ¨¡ç‰ˆçš„è¡¨å¤´
            document.getElementById('img-header-title').innerText = t.imgHeader;
            document.getElementById('img-header-subtitle').innerText = t.imgSubHeader;
            document.getElementById('img-th-time').innerText = t.imgThTime;
            document.getElementById('img-th-subject').innerText = t.imgThSubject;
            document.getElementById('img-th-details').innerText = t.imgThDetails;
        }

        function getSubjectsByGrade() {
            const grouped = {};
            GRADE_SECTIONS.forEach(section => {
                const examsInGrade = EXAM_DATA.filter(e => e.grade === section.key);
                const unique = [];
                const seen = new Set();
                
                examsInGrade.forEach(exam => {
                    const uniqueKey = `${exam.subject}|${exam.board}`;
                    if (!seen.has(uniqueKey)) {
                        seen.add(uniqueKey);
                        unique.push({
                            name: exam.subject,
                            board: exam.board,
                            fullKey: uniqueKey
                        });
                    }
                });
                grouped[section.key] = unique;
            });
            return grouped;
        }

        const subjectsByGrade = getSubjectsByGrade();

        // æ¸²æŸ“é€‰æ‹©åŒºåŸŸ
        function renderSections() {
            const container = document.getElementById('sections-container');
            container.innerHTML = '';
            const t = i18n[state.lang];

            GRADE_SECTIONS.forEach(section => {
                const subjects = subjectsByGrade[section.key];
                if (!subjects || subjects.length === 0) return;

                // åŠ¨æ€è·å–å¹´çº§æ ‡é¢˜
                let gradeTitle = section.title; 
                // å¦‚æœéœ€è¦å¯¹æ ‡é¢˜ä¹Ÿè¿›è¡Œç¿»è¯‘ï¼Œå¯ä»¥åœ¨ i18n é‡Œåšæ˜ å°„ï¼Œç›®å‰ä¿ç•™åŸæ ·æˆ–ç®€å•æ˜ å°„
                if (section.key === 'IGCSE') gradeTitle = t.gradeIG;
                if (section.key === 'AS') gradeTitle = t.gradeAS;
                if (section.key === 'ALevel') gradeTitle = t.gradeAL;

                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'fade-in-init'; 
                
                sectionDiv.innerHTML = `
                    <h2 class="text-xl font-bold flex items-center gap-2 mb-4 text-gray-800 border-b border-gray-100 pb-2">
                        <span class="p-2 bg-indigo-50 text-indigo-600 rounded-lg">
                            <i data-lucide="${section.icon}" class="w-5 h-5"></i>
                        </span>
                        ${gradeTitle}
                    </h2>
                `;

                const gridDiv = document.createElement('div');
                gridDiv.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3';

                subjects.forEach(sub => {
                    const isSelected = state.selectedSubjects.has(sub.fullKey);
                    const btn = document.createElement('button');
                    btn.onclick = (e) => toggleSubject(sub.fullKey, sub, e.currentTarget);
                    updateButtonVisual(btn, sub, isSelected);
                    gridDiv.appendChild(btn);
                });

                sectionDiv.appendChild(gridDiv);
                container.appendChild(sectionDiv);
            });
            lucide.createIcons();
        }

        function updateButtonVisual(btn, sub, isSelected) {
            btn.className = `
                relative flex flex-col items-start p-3 rounded-xl border-2 transition-all duration-200 text-left w-full
                ${isSelected 
                    ? 'border-indigo-500 bg-indigo-50/50 shadow-sm' 
                    : 'border-gray-100 hover:border-indigo-200 hover:bg-gray-50'}
            `;
            const badgeColor = sub.board === 'CIE' ? 'bg-orange-500' : 'bg-blue-500';
            btn.innerHTML = `
                <div class="flex justify-between w-full items-start mb-1">
                    <span class="text-xs font-bold px-2 py-0.5 rounded text-white ${badgeColor}">
                        ${sub.board}
                    </span>
                    ${isSelected ? '<i data-lucide="check" class="w-5 h-5 text-indigo-600"></i>' : ''}
                </div>
                <span class="font-semibold ${isSelected ? 'text-indigo-900' : 'text-gray-700'}">
                    ${sub.name}
                </span>
            `;
        }

        function toggleSubject(key, subData, btnElement) {
            if (state.selectedSubjects.has(key)) {
                state.selectedSubjects.delete(key);
            } else {
                state.selectedSubjects.add(key);
            }
            document.getElementById('success-message').classList.add('hidden');
            const isSelected = state.selectedSubjects.has(key);
            updateButtonVisual(btnElement, subData, isSelected);
            lucide.createIcons();
            updatePreview();
        }

        document.getElementById('alert-toggle').addEventListener('change', (e) => {
            state.includeAlerts = e.target.checked;
            updatePreviewUIStatus();
            document.getElementById('success-message').classList.add('hidden');
        });

        function getMyExams() {
            return EXAM_DATA.filter(exam => {
                const key = `${exam.subject}|${exam.board}`;
                return state.selectedSubjects.has(key);
            }).sort((a, b) => new Date(`${a.date}T${a.time}`) - new Date(`${b.date}T${b.time}`));
        }

        function updatePreviewUIStatus() {
            const myExams = getMyExams();
            const statusText = document.getElementById('preview-status-text');
            const bellContainer = document.getElementById('bell-icon-container');
            const t = i18n[state.lang];

            if (myExams.length === 0) {
                statusText.innerText = t.statusEmpty;
            } else {
                statusText.innerText = t.statusSelected(myExams.length, state.includeAlerts);
            }

            if (state.includeAlerts) {
                bellContainer.className = "p-2 rounded-full transition-colors bg-indigo-100 shrink-0";
                bellContainer.innerHTML = '<i data-lucide="bell" class="w-6 h-6 text-indigo-600"></i>';
            } else {
                bellContainer.className = "p-2 rounded-full transition-colors bg-gray-100 shrink-0";
                bellContainer.innerHTML = '<i data-lucide="bell-off" class="w-6 h-6 text-gray-400"></i>';
            }
            lucide.createIcons();
        }

        function updatePreview() {
            const myExams = getMyExams();
            const tableBody = document.getElementById('preview-table-body');
            const emptyState = document.getElementById('empty-state');
            const previewContainer = document.getElementById('preview-container');
            const generateBtn = document.getElementById('generate-btn');
            const generateImgBtn = document.getElementById('generate-img-btn');
            const t = i18n[state.lang];

            updatePreviewUIStatus();

            if (myExams.length === 0) {
                emptyState.classList.remove('hidden');
                previewContainer.classList.add('hidden');
                generateBtn.disabled = true;
                generateImgBtn.disabled = true;
                const disabledClass = "flex items-center gap-2 px-4 py-3 rounded-lg font-bold shadow-md transition-all bg-gray-200 text-gray-400 cursor-not-allowed text-sm";
                generateBtn.className = disabledClass;
                generateImgBtn.className = disabledClass;
                return;
            }

            emptyState.classList.add('hidden');
            previewContainer.classList.remove('hidden');
            
            const activeClass = "flex items-center gap-2 px-4 py-3 rounded-lg font-bold shadow-md transition-all bg-indigo-600 hover:bg-indigo-700 text-white hover:scale-105 active:scale-95 cursor-pointer text-sm";
            const activeImgClass = "flex items-center gap-2 px-4 py-3 rounded-lg font-bold shadow-md transition-all bg-emerald-600 hover:bg-emerald-700 text-white hover:scale-105 active:scale-95 cursor-pointer text-sm";
            
            generateBtn.disabled = false;
            generateBtn.className = activeClass;
            
            generateImgBtn.disabled = false;
            generateImgBtn.className = activeImgClass;

            tableBody.innerHTML = myExams.map(exam => `
                <tr class="hover:bg-indigo-50/30 transition-colors">
                    <td class="p-4 whitespace-nowrap font-medium text-gray-900">${exam.date}</td>
                    <td class="p-4 whitespace-nowrap text-gray-600">
                        ${exam.time} <span class="text-xs text-gray-400">(${exam.duration}m)</span>
                    </td>
                    <td class="p-4">
                        <div class="font-bold text-indigo-900">${exam.subject}</div>
                        <div class="text-gray-500">${exam.paper}</div>
                        <div class="text-xs text-orange-600 mt-1 font-medium">${t.arriveEarly}</div>
                    </td>
                    <td class="p-4 hidden sm:table-cell">
                        <span class="text-xs font-bold px-2 py-1 rounded ${exam.board === 'CIE' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}">
                            ${exam.board}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        // --- 5. ç”Ÿæˆ ICS é€»è¾‘ ---
        document.getElementById('generate-btn').addEventListener('click', () => {
            const myExams = getMyExams();
            if (myExams.length === 0) return;
            const t = i18n[state.lang];

            let icsContent = 
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//MySchool//ExamSchedule//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
`;
            myExams.forEach(exam => {
                const startDateTime = new Date(`${exam.date}T${exam.time}`);
                const endDateTime = new Date(startDateTime.getTime() + exam.duration * 60000);
                const formatICSDate = (date) => date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

                const description = [
                    `${t.thSubject}: ${exam.subject}`,
                    `${exam.paper}`,
                    `${t.thTime}: ${exam.duration} min`,
                    `${t.thBoard}: ${exam.board}`,
                    `${t.room}: ${exam.room || t.roomPending}`,
                    t.arriveEarly
                ].join('\\n');

                let alarmBlock = '';
                if (state.includeAlerts) {
                    alarmBlock = `BEGIN:VALARM
TRIGGER:-P1D
ACTION:DISPLAY
DESCRIPTION:${t.reminder1d} (${exam.subject})
END:VALARM
BEGIN:VALARM
TRIGGER:-PT2H
ACTION:DISPLAY
DESCRIPTION:${t.reminder2h} (${exam.subject})
END:VALARM`;
                }

                icsContent += 
`BEGIN:VEVENT
UID:${exam.id}-${Date.now()}@myschool.com
DTSTAMP:${formatICSDate(new Date())}
DTSTART:${formatICSDate(startDateTime)}
DTEND:${formatICSDate(endDateTime)}
SUMMARY:ğŸ“ [${exam.board}] ${exam.subject}
DESCRIPTION:${description}
LOCATION:${exam.room || 'School Exam Hall'}
STATUS:CONFIRMED
${alarmBlock}
END:VEVENT
`;
            });
            icsContent += `END:VCALENDAR`;

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', 'My_Exam_Schedule_2025.ics');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccess(t.successTitle, t.successDescIcs(state.includeAlerts));
        });

        // --- 6. ç”Ÿæˆå›¾ç‰‡é€»è¾‘ ---
        function generateImage() {
            const myExams = getMyExams();
            if (myExams.length === 0) return;
            const t = i18n[state.lang];

            // 1. å¡«å……éšè—çš„ Table å†…å®¹
            const imgTableBody = document.getElementById('image-table-body');
            document.getElementById('img-total-count').innerText = `${myExams.length} Exams`;
            
            imgTableBody.innerHTML = myExams.map(exam => `
                <tr>
                    <td class="py-3 pl-2 align-top">
                        <div class="font-bold text-indigo-900 text-lg">${exam.date}</div>
                        <div class="text-indigo-600 font-medium">${exam.time}</div>
                        <div class="text-gray-400 text-xs mt-1">${exam.duration} mins</div>
                    </td>
                    <td class="py-3 align-top">
                        <div class="font-bold text-gray-900 text-lg">${exam.subject}</div>
                        <div class="text-gray-600 mb-2">${exam.paper}</div>
                        <span class="inline-block text-xs font-bold px-1.5 py-0.5 rounded ${exam.board === 'CIE' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}">
                            ${exam.board}
                        </span>
                    </td>
                    <td class="py-3 align-top">
                        <div class="flex items-start gap-1 text-gray-700">
                            <span class="font-bold">ğŸ“ ${t.room}:</span> ${exam.room || t.roomPending}
                        </div>
                        <div class="text-orange-600 font-bold text-xs mt-1">
                            âš ï¸ ${t.arriveEarly}
                        </div>
                    </td>
                </tr>
            `).join('');

            // 2. ä½¿ç”¨ html2canvas æˆªå›¾
            const element = document.getElementById('image-export-container');
            
            // ä¸´æ—¶è®©å®ƒå¯è§ä½†é€æ˜ï¼Œä»¥ç¡®ä¿æ¸²æŸ“æ­£ç¡®ï¼ˆè™½ç„¶ absolute -9999px é€šå¸¸ä¹Ÿå·¥ä½œï¼‰
            // è¿™é‡Œ html2canvas å¯ä»¥å¤„ç† hidden æˆ– off-screen å…ƒç´ 
            html2canvas(element, {
                scale: 2, // æé«˜æ¸…æ™°åº¦
                backgroundColor: null,
            }).then(canvas => {
                // ä¸‹è½½å›¾ç‰‡
                const link = document.createElement('a');
                link.download = 'My_Exam_Schedule.png';
                link.href = canvas.toDataURL("image/png");
                link.click();

                showSuccess(t.successTitle, t.successDescImg);
            });
        }

        function showSuccess(title, desc) {
            const successMsg = document.getElementById('success-message');
            document.getElementById('success-title').innerText = title;
            document.getElementById('success-desc').innerText = desc;
            successMsg.classList.remove('hidden');
        }

        // åˆå§‹åŒ–
        updateUIText();
        renderSections();
        updatePreview();

    </script>
</body>
</html>


