<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 è€ƒè¯•å­£æ—¥å†ç”Ÿæˆå™¨</title>
    <!-- å¼•å…¥ Tailwind CSS è¿›è¡Œæ ·å¼è®¾è®¡ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Lucide å›¾æ ‡åº“ -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ï¼Œæ›´ç¾è§‚ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #c7c7cc;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1aa;
        }
        /* ä»…ä¿ç•™åˆå§‹åŠ è½½æ—¶çš„æ·¡å…¥åŠ¨ç”»ï¼Œé¿å…åç»­æ“ä½œé—ªçƒ */
        .fade-in-init {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 min-h-screen py-8 px-4">

    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden border border-gray-200">
        
        <!-- å¤´éƒ¨åŒºåŸŸ -->
        <div class="bg-indigo-600 p-8 text-white">
            <h1 class="text-3xl font-bold flex items-center gap-3">
                <i data-lucide="calendar" class="w-8 h-8"></i>
                2025 è€ƒè¯•å­£æ—¥å†ç”Ÿæˆå™¨
            </h1>
            <p class="mt-3 text-indigo-100 max-w-2xl">
                ä¸“ä¸º IG, AS, A-Level åŒå­¦è®¾è®¡ã€‚å‹¾é€‰ä½ çš„ç§‘ç›®ï¼Œè‡ªåŠ¨ç”ŸæˆåŒ…å«<b>è€ƒå‰æé†’</b>ã€<b>è€ƒè¯•å±€</b>åŠ<b>è€ƒåœºä¿¡æ¯</b>çš„ä¸“å±æ—¥å†ã€‚
            </p>
        </div>

        <div class="p-8">
            <!-- è€ƒè¯•ç§‘ç›®é€‰æ‹©åŒºåŸŸ (å°†ç”± JS åŠ¨æ€ç”Ÿæˆ) -->
            <div id="sections-container" class="space-y-10">
                <!-- å†…å®¹åŠ è½½ä¸­... -->
            </div>

            <!-- åº•éƒ¨é¢„è§ˆå’Œæ“ä½œåŒºåŸŸ -->
            <div class="mt-12 pt-8 border-t border-gray-100">
                <div class="flex flex-col sm:flex-row items-end justify-between mb-6 gap-4">
                    <!-- å·¦ä¾§çŠ¶æ€ -->
                    <div class="flex items-center gap-3">
                        <div id="bell-icon-container" class="p-2 rounded-full transition-colors bg-indigo-100">
                            <i data-lucide="bell" class="w-6 h-6 text-indigo-600"></i>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-gray-900">å·²é€‰è€ƒè¯•é¢„è§ˆ</h2>
                            <p id="preview-status-text" class="text-sm text-gray-500">
                                è¯·é€‰æ‹©ç§‘ç›®...
                            </p>
                        </div>
                    </div>
                    
                    <!-- å³ä¾§æ“ä½œ -->
                    <div class="flex flex-col items-end gap-3">
                        <label class="flex items-center gap-2 cursor-pointer text-sm font-medium text-gray-600 hover:text-indigo-700 transition-colors select-none bg-white px-2 py-1 rounded border border-transparent hover:border-gray-100">
                            <input type="checkbox" id="alert-toggle" checked class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 accent-indigo-600">
                            <span>æ·»åŠ è€ƒå‰æé†’</span>
                        </label>

                        <button id="generate-btn" disabled class="flex items-center gap-2 px-6 py-3 rounded-lg font-bold shadow-md transition-all bg-gray-200 text-gray-400 cursor-not-allowed">
                            <i data-lucide="download" class="w-5 h-5"></i>
                            ç”Ÿæˆæ—¥å† (.ics)
                        </button>
                    </div>
                </div>

                <!-- åˆ—è¡¨é¢„è§ˆå®¹å™¨ -->
                <div id="preview-container" class="bg-white rounded-xl border border-gray-200 shadow-inner overflow-hidden max-h-[500px] overflow-y-auto hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-gray-500 font-medium border-b border-gray-200 sticky top-0">
                            <tr>
                                <th class="p-4">æ—¥æœŸ</th>
                                <th class="p-4">æ—¶é—´</th>
                                <th class="p-4">ç§‘ç›® / è¯•å·</th>
                                <th class="p-4 hidden sm:table-cell">è€ƒè¯•å±€</th>
                            </tr>
                        </thead>
                        <tbody id="preview-table-body" class="divide-y divide-gray-100">
                            <!-- è¡Œæ•°æ®å°†ç”± JS æ’å…¥ -->
                        </tbody>
                    </table>
                </div>

                <!-- ç©ºçŠ¶æ€æç¤º -->
                <div id="empty-state" class="text-center py-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                    <p class="text-gray-400">è¯·åœ¨ä¸Šæ–¹é€‰æ‹©ç§‘ç›®ä»¥é¢„è§ˆè¯¦æƒ…</p>
                </div>

                <!-- æˆåŠŸæç¤º -->
                <div id="success-message" class="hidden mt-4 p-4 bg-green-50 border border-green-200 rounded-lg flex items-start gap-3 fade-in-init">
                    <i data-lucide="alert-circle" class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"></i>
                    <div class="text-sm text-green-800">
                        <p class="font-bold">æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼</p>
                        <p id="success-desc">è¯·åœ¨æ‰‹æœºæˆ–ç”µè„‘ä¸Šæ‰“å¼€è¯¥æ–‡ä»¶ã€‚</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="text-center mt-8 text-gray-400 text-xs">
        <p>Supported Exam Boards: CIE & Edexcel â€¢ Exam Season 2025</p>
    </div>

    <!-- é€»è¾‘è„šæœ¬ -->
    <script>
        // --- 1. æ•°æ®æºé…ç½® ---
        // ä½ å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šçš„è€ƒè¯•æ•°æ®
        const EXAM_DATA = [
            // --- IGCSE ---
            { id: 'ig_math_p2', grade: 'IGCSE', board: 'CIE', subject: 'Maths (0580)', paper: 'Paper 2 (Extended)', date: '2025-05-02', time: '09:00', duration: 90 },
            { id: 'ig_math_p4', grade: 'IGCSE', board: 'CIE', subject: 'Maths (0580)', paper: 'Paper 4 (Extended)', date: '2025-05-05', time: '13:00', duration: 150 },
            { id: 'ig_phy_p4', grade: 'IGCSE', board: 'CIE', subject: 'Physics (0625)', paper: 'Theory', date: '2025-05-12', time: '09:00', duration: 75 },
            
            // --- AS Level ---
            { id: 'as_econ_p1', grade: 'AS', board: 'CIE', subject: 'Economics (9708)', paper: 'Multiple Choice', date: '2025-06-10', time: '13:00', duration: 60 },
            { id: 'as_econ_p2', grade: 'AS', board: 'CIE', subject: 'Economics (9708)', paper: 'Data Response', date: '2025-05-12', time: '09:00', duration: 90 },
            { id: 'as_math_pure', grade: 'AS', board: 'Edexcel', subject: 'Maths (Pure)', paper: 'Pure 1', date: '2025-05-15', time: '09:00', duration: 120 },
            
            // --- A Level ---
            { id: 'al_psy_p3', grade: 'ALevel', board: 'CIE', subject: 'Psychology (9990)', paper: 'Specialist Options', date: '2025-05-20', time: '09:00', duration: 90 },
            { id: 'al_chem_p4', grade: 'ALevel', board: 'CIE', subject: 'Chemistry (9701)', paper: 'Structured Questions', date: '2025-05-22', time: '13:00', duration: 120 },
            { id: 'al_math_stat', grade: 'ALevel', board: 'Edexcel', subject: 'Maths (Stats)', paper: 'Statistics 2', date: '2025-06-01', time: '09:00', duration: 90 },
        ];

        const GRADE_SECTIONS = [
            { key: 'IGCSE', title: 'IGCSE', icon: 'book-open' },
            { key: 'AS', title: 'AS Level', icon: 'layers' },
            { key: 'ALevel', title: 'A Level', icon: 'graduation-cap' },
        ];

        // --- 2. çŠ¶æ€ç®¡ç† ---
        let state = {
            selectedSubjects: new Set(), // å­˜å‚¨é€‰ä¸­çš„ "subject|board" å­—ç¬¦ä¸²
            includeAlerts: true
        };

        // --- 3. åˆå§‹åŒ–ä¸æ¸²æŸ“é€»è¾‘ ---
        
        // é¢„å¤„ç†æ•°æ®ï¼šæŒ‰å¹´çº§åˆ†ç»„å¹¶æå–å”¯ä¸€ç§‘ç›®
        function getSubjectsByGrade() {
            const grouped = {};
            GRADE_SECTIONS.forEach(section => {
                const examsInGrade = EXAM_DATA.filter(e => e.grade === section.key);
                const unique = [];
                const seen = new Set();
                
                examsInGrade.forEach(exam => {
                    const uniqueKey = `${exam.subject}|${exam.board}`;
                    if (!seen.has(uniqueKey)) {
                        seen.add(uniqueKey);
                        unique.push({
                            name: exam.subject,
                            board: exam.board,
                            fullKey: uniqueKey
                        });
                    }
                });
                grouped[section.key] = unique;
            });
            return grouped;
        }

        const subjectsByGrade = getSubjectsByGrade();

        // æ¸²æŸ“ä¸»ç•Œé¢ (åªåœ¨åˆå§‹åŒ–æ—¶è°ƒç”¨ä¸€æ¬¡)
        function renderSections() {
            const container = document.getElementById('sections-container');
            container.innerHTML = '';

            GRADE_SECTIONS.forEach(section => {
                const subjects = subjectsByGrade[section.key];
                if (!subjects || subjects.length === 0) return;

                // åˆ›å»º Section å®¹å™¨
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'fade-in-init'; // ä»…åˆå§‹åŒ–æ—¶æ·¡å…¥
                
                // æ ‡é¢˜
                sectionDiv.innerHTML = `
                    <h2 class="text-xl font-bold flex items-center gap-2 mb-4 text-gray-800 border-b border-gray-100 pb-2">
                        <span class="p-2 bg-indigo-50 text-indigo-600 rounded-lg">
                            <i data-lucide="${section.icon}" class="w-5 h-5"></i>
                        </span>
                        ${section.title}
                    </h2>
                `;

                // ç½‘æ ¼å®¹å™¨
                const gridDiv = document.createElement('div');
                gridDiv.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3';

                // ç”ŸæˆæŒ‰é’®
                subjects.forEach(sub => {
                    const isSelected = state.selectedSubjects.has(sub.fullKey);
                    const btn = document.createElement('button');
                    
                    // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œä¼ å…¥å½“å‰çš„ sub æ•°æ®å’ŒæŒ‰é’®å…ƒç´ æœ¬èº«
                    btn.onclick = (e) => toggleSubject(sub.fullKey, sub, e.currentTarget);

                    updateButtonVisual(btn, sub, isSelected);
                    gridDiv.appendChild(btn);
                });

                sectionDiv.appendChild(gridDiv);
                container.appendChild(sectionDiv);
            });
            
            // åˆ·æ–°å›¾æ ‡
            lucide.createIcons();
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°å•ä¸ªæŒ‰é’®çš„è§†è§‰æ ·å¼
        function updateButtonVisual(btn, sub, isSelected) {
            btn.className = `
                relative flex flex-col items-start p-3 rounded-xl border-2 transition-all duration-200 text-left w-full
                ${isSelected 
                    ? 'border-indigo-500 bg-indigo-50/50 shadow-sm' 
                    : 'border-gray-100 hover:border-indigo-200 hover:bg-gray-50'}
            `;
            
            const badgeColor = sub.board === 'CIE' ? 'bg-orange-500' : 'bg-blue-500';
            
            btn.innerHTML = `
                <div class="flex justify-between w-full items-start mb-1">
                    <span class="text-xs font-bold px-2 py-0.5 rounded text-white ${badgeColor}">
                        ${sub.board}
                    </span>
                    ${isSelected ? '<i data-lucide="check" class="w-5 h-5 text-indigo-600"></i>' : ''}
                </div>
                <span class="font-semibold ${isSelected ? 'text-indigo-900' : 'text-gray-700'}">
                    ${sub.name}
                </span>
            `;
        }

        // åˆ‡æ¢ç§‘ç›®é€‰ä¸­çŠ¶æ€ (ä¿®æ”¹åï¼šä¸å†é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨ï¼Œåªæ›´æ–°å½“å‰æŒ‰é’®)
        function toggleSubject(key, subData, btnElement) {
            // æ›´æ–°çŠ¶æ€
            if (state.selectedSubjects.has(key)) {
                state.selectedSubjects.delete(key);
            } else {
                state.selectedSubjects.add(key);
            }

            // éšè—ä¹‹å‰çš„æˆåŠŸæ¶ˆæ¯
            document.getElementById('success-message').classList.add('hidden');
            
            // 1. åªæ›´æ–°å½“å‰è¢«ç‚¹å‡»æŒ‰é’®çš„æ ·å¼
            const isSelected = state.selectedSubjects.has(key);
            updateButtonVisual(btnElement, subData, isSelected);
            
            // 2. å› ä¸º innerHTML å˜äº†ï¼Œå›¾æ ‡éœ€è¦é‡æ–°æ¸²æŸ“ä¸€ä¸‹
            lucide.createIcons();

            // 3. æ›´æ–°åº•éƒ¨çš„é¢„è§ˆè¡¨æ ¼
            updatePreview();
        }

        // åˆ‡æ¢æé†’å¼€å…³
        document.getElementById('alert-toggle').addEventListener('change', (e) => {
            state.includeAlerts = e.target.checked;
            updatePreviewUIStatus();
            // éšè—ä¹‹å‰çš„æˆåŠŸæ¶ˆæ¯
            document.getElementById('success-message').classList.add('hidden');
        });

        // è·å–å½“å‰é€‰ä¸­çš„æ‰€æœ‰è€ƒè¯•
        function getMyExams() {
            return EXAM_DATA.filter(exam => {
                const key = `${exam.subject}|${exam.board}`;
                return state.selectedSubjects.has(key);
            }).sort((a, b) => new Date(`${a.date}T${a.time}`) - new Date(`${b.date}T${b.time}`));
        }

        // æ›´æ–°åº•éƒ¨çš„çŠ¶æ€æ–‡å­—å’Œå›¾æ ‡
        function updatePreviewUIStatus() {
            const myExams = getMyExams();
            const statusText = document.getElementById('preview-status-text');
            const bellContainer = document.getElementById('bell-icon-container');

            // æ›´æ–°æ–‡å­—
            if (myExams.length === 0) {
                statusText.innerText = "è¯·é€‰æ‹©ç§‘ç›®...";
            } else {
                statusText.innerText = `å…± ${myExams.length} åœºè€ƒè¯• â€¢ ${state.includeAlerts ? 'å·²å¼€å¯è‡ªåŠ¨æé†’ (1å¤©å‰ & 2å°æ—¶å‰)' : 'è‡ªåŠ¨æé†’å·²å…³é—­'}`;
            }

            // æ›´æ–°é“ƒé“›æ ·å¼
            if (state.includeAlerts) {
                bellContainer.className = "p-2 rounded-full transition-colors bg-indigo-100";
                bellContainer.innerHTML = '<i data-lucide="bell" class="w-6 h-6 text-indigo-600"></i>';
            } else {
                bellContainer.className = "p-2 rounded-full transition-colors bg-gray-100";
                bellContainer.innerHTML = '<i data-lucide="bell-off" class="w-6 h-6 text-gray-400"></i>';
            }
            lucide.createIcons();
        }

        // æ›´æ–°é¢„è§ˆè¡¨æ ¼
        function updatePreview() {
            const myExams = getMyExams();
            const tableBody = document.getElementById('preview-table-body');
            const emptyState = document.getElementById('empty-state');
            const previewContainer = document.getElementById('preview-container');
            const generateBtn = document.getElementById('generate-btn');

            updatePreviewUIStatus();

            if (myExams.length === 0) {
                emptyState.classList.remove('hidden');
                previewContainer.classList.add('hidden');
                generateBtn.disabled = true;
                generateBtn.className = "flex items-center gap-2 px-6 py-3 rounded-lg font-bold shadow-md transition-all bg-gray-200 text-gray-400 cursor-not-allowed";
                return;
            }

            emptyState.classList.add('hidden');
            previewContainer.classList.remove('hidden');
            
            // æ¿€æ´»æŒ‰é’®
            generateBtn.disabled = false;
            generateBtn.className = "flex items-center gap-2 px-6 py-3 rounded-lg font-bold shadow-md transition-all bg-indigo-600 hover:bg-indigo-700 text-white hover:scale-105 active:scale-95 cursor-pointer";

            // æ¸²æŸ“è¡¨æ ¼è¡Œ
            tableBody.innerHTML = myExams.map(exam => `
                <tr class="hover:bg-indigo-50/30 transition-colors">
                    <td class="p-4 whitespace-nowrap font-medium text-gray-900">${exam.date}</td>
                    <td class="p-4 whitespace-nowrap text-gray-600">
                        ${exam.time} <span class="text-xs text-gray-400">(${exam.duration}m)</span>
                    </td>
                    <td class="p-4">
                        <div class="font-bold text-indigo-900">${exam.subject}</div>
                        <div class="text-gray-500">${exam.paper}</div>
                        <div class="text-xs text-orange-600 mt-1 font-medium">è¯·æå‰15åˆ†é’Ÿåˆ°è¾¾</div>
                    </td>
                    <td class="p-4 hidden sm:table-cell">
                        <span class="text-xs font-bold px-2 py-1 rounded ${exam.board === 'CIE' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}">
                            ${exam.board}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        // --- 4. ç”Ÿæˆ ICS æ–‡ä»¶é€»è¾‘ ---
        document.getElementById('generate-btn').addEventListener('click', () => {
            const myExams = getMyExams();
            if (myExams.length === 0) return;

            let icsContent = 
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//MySchool//ExamSchedule//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
`;

            myExams.forEach(exam => {
                const startDateTime = new Date(`${exam.date}T${exam.time}`);
                const endDateTime = new Date(startDateTime.getTime() + exam.duration * 60000);

                const formatICSDate = (date) => {
                    return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                };

                const dtStart = formatICSDate(startDateTime);
                const dtEnd = formatICSDate(endDateTime);
                const nowStamp = formatICSDate(new Date());

                const description = [
                    `ç§‘ç›®: ${exam.subject}`,
                    `è¯•å·: ${exam.paper}`,
                    `æ—¶é•¿: ${exam.duration}åˆ†é’Ÿ`,
                    `è€ƒè¯•å±€: ${exam.board}`,
                    `è€ƒè¯•æˆ¿é—´: ${exam.room || 'å¾…å®š (è¯·æŸ¥çœ‹å­¦æ ¡å…¬å‘Š)'}`,
                    `è¯·æå‰15åˆ†é’Ÿåˆ°è¾¾è€ƒåœºå‡†å¤‡ã€‚`
                ].join('\\n');

                let alarmBlock = '';
                if (state.includeAlerts) {
                    alarmBlock = `BEGIN:VALARM
TRIGGER:-P1D
ACTION:DISPLAY
DESCRIPTION:Reminder: ${exam.subject} Exam is tomorrow!
END:VALARM
BEGIN:VALARM
TRIGGER:-PT2H
ACTION:DISPLAY
DESCRIPTION:Reminder: ${exam.subject} Exam in 2 hours. Go to prep room soon!
END:VALARM`;
                }

                icsContent += 
`BEGIN:VEVENT
UID:${exam.id}-${Date.now()}@myschool.com
DTSTAMP:${nowStamp}
DTSTART:${dtStart}
DTEND:${dtEnd}
SUMMARY:ğŸ“ [${exam.board}] ${exam.subject} - ${exam.paper}
DESCRIPTION:${description}
LOCATION:${exam.room || 'School Exam Hall'}
STATUS:CONFIRMED
${alarmBlock}
END:VEVENT
`;
            });

            icsContent += `END:VCALENDAR`;

            // ä¸‹è½½æ–‡ä»¶
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', 'My_Exam_Schedule_2025.ics');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            const successMsg = document.getElementById('success-message');
            const successDesc = document.getElementById('success-desc');
            successMsg.classList.remove('hidden');
            successDesc.innerText = state.includeAlerts 
                ? "è¯·åœ¨æ‰‹æœºæˆ–ç”µè„‘ä¸Šæ‰“å¼€è¯¥æ–‡ä»¶ã€‚å¯¼å…¥åï¼Œæ¯åœºè€ƒè¯•å°†åŒ…å«ï¼šå¼€è€ƒå‰ 1 å¤©åŠå¼€è€ƒå‰ 2 å°æ—¶çš„è‡ªåŠ¨æé†’ã€‚"
                : "æ–‡ä»¶å·²ç”Ÿæˆï¼ˆæ— æé†’ç‰ˆæœ¬ï¼‰ã€‚ç›´æ¥å¯¼å…¥å³å¯æŸ¥çœ‹æ—¶é—´è¡¨ã€‚";
        });

        // é¦–æ¬¡åŠ è½½
        renderSections();
        updatePreview();

    </script>
</body>
</html>
